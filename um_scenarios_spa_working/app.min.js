const $=(s,r=document)=>r.querySelector(s),$$_=(s,r=document)=>Array.from(r.querySelectorAll(s)),fmtDate=i=>new Date(i).toLocaleString(),debounce=(f,m=300)=>{let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>f(...a),m)}};const perfPanel={api:$("#apiTime"),render:$("#renderTime"),count:$("#count"),set({api:a,render:r,count:c}){a!=null&&(this.api.textContent=a.toFixed(0)),r!=null&&(this.render.textContent=r.toFixed(0)),c!=null&&(this.count.textContent=c)}};const state={raw:[],filtered:[],q:"",minVal:0,favorites:new Set};const cache=new Map;async function loadData(u="data.json"){console.log("fetch:",u);if(cache.has(u))return cache.get(u);const t0=performance.now(),res=await fetch(u,{cache:"no-store"});if(!res.ok)throw new Error(`HTTP ${res.status}`);const json=await res.json(),t1=performance.now();return perfPanel.set({api:t1-t0}),cache.set(u,json),json}function applyFilters(){const q=state.q.trim().toLowerCase(),min=Number(state.minVal)||0;state.filtered=state.raw.filter(it=>{const inName=it.name.toLowerCase().includes(q),inTags=it.tags?.some(t=>t.toLowerCase().includes(q)),passQ=q?inName||inTags:!0,passVal=it.value>=min;return passQ&&passVal})}const tpl=$("#card-tpl");function cardNode(item){const node=tpl.content.firstElementChild.cloneNode(!0),img=$(".thumb",node),sk=$(".skeleton",node);img.alt=item.name,img.dataset.src=item.image,$(".title",node).textContent=item.name,$(".badge",node).textContent=item.value,$(".tags",node).textContent="#"+(item.tags||[]).join(" #"),$(".updated",node).textContent=fmtDate(item.updatedAt);const favBtn=$(".fav",node);favBtn.setAttribute("aria-pressed",state.favorites.has(item.id)?"true":"false"),favBtn.addEventListener("click",()=>{const p=favBtn.getAttribute("aria-pressed")==="true";favBtn.setAttribute("aria-pressed",p?"false":"true"),setTimeout(()=>{p?state.favorites.delete(item.id):state.favorites.add(item.id)},120)});const holder=$(".sparkline-holder",node);return holder.dataset.series=(item.series||[]).join(","),img.addEventListener("load",()=>{sk.style.opacity=0,img.style.opacity=1,setTimeout(()=>sk.remove(),400)}),node}const listEl=$("#list"),emptyEl=$("#empty");function render(){performance.mark("r:start"),listEl.innerHTML="",state.filtered.length===0?emptyEl.hidden=!1:(emptyEl.hidden=!0,(()=>{const frag=document.createDocumentFragment();state.filtered.forEach(it=>frag.appendChild(cardNode(it))),listEl.appendChild(frag),perfPanel.set({count:state.filtered.length}),observeLazyImages(),observeLazySparklines()})()),performance.mark("r:end"),performance.measure("render","r:start","r:end");const m=performance.getEntriesByName("render").pop();perfPanel.set({render:m.duration})}let imgObserver;function observeLazyImages(){imgObserver?.disconnect(),imgObserver=new IntersectionObserver((entries,obs)=>{for(const e of entries)if(e.isIntersecting){const img=e.target,src=img.dataset.src;src&&(img.src=src),obs.unobserve(img)}},{rootMargin:"200px 0px"}),$$_(".thumb.lozad",listEl).forEach(img=>imgObserver.observe(img))}let sparkObserver;function observeLazySparklines(){sparkObserver?.disconnect(),sparkObserver=new IntersectionObserver((entries,obs)=>{for(const e of entries){if(!e.isIntersecting)continue;const holder=e.target,series=holder.dataset.series.split(",").map(Number).filter(n=>!Number.isNaN(n));series.length&&(holder.innerHTML=renderSparkline(series),holder.firstElementChild.classList.add("sparkline")),obs.unobserve(holder)}},{rootMargin:"120px 0px"}),$$_(".sparkline-holder",listEl).forEach(h=>sparkObserver.observe(h))}function renderSparkline(d){const w=300,h=42,pad=6,min=Math.min(...d),max=Math.max(...d),dx=(w-pad*2)/(d.length-1||1),scaleY=v=>{if(max===min)return h/2;return h-pad-(v-min)/(max-min)*(h-pad*2)},pts=d.map((v,i)=>`${pad+i*dx},${scaleY(v)}`).join(" ");return`<svg viewBox="0 0 ${w} ${h}" preserveAspectRatio="none" role="img" aria-label="Мини-график"><polyline points="${pts}" fill="none" stroke="currentColor" stroke-width="2"/></svg>`}const qInput=$("#q"),minInput=$("#minVal"),minOut=$("#minValOut");qInput.addEventListener("input",debounce(()=>{state.q=qInput.value,applyFilters(),render()},300)),minInput.addEventListener("input",()=>{state.minVal=minInput.value,minOut.textContent=state.minVal,applyFilters(),render()}),(async function init(){try{const data=await loadData("data.json");console.log("data loaded:",data);state.raw=data.items||[],applyFilters(),render()}catch(e){console.error("init error",e),$("#empty").hidden=!1,$("#empty").textContent="Ошибка загрузки данных."}})();